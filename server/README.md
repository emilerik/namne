# Name Voting API Backend

A FastAPI backend for the name voting application with SQLite (local) and PostgreSQL (production) support.

## Features

- FastAPI web framework
- SQLite for local development, PostgreSQL for production
- SQLAlchemy ORM
- Basic HTTP authentication
- User management
- Name voting system with matching logic
- Ready for deployment to Render.com

## Local Development

### Prerequisites

- Python 3.11+
- pip

### Setup

1. Create a virtual environment:

```bash
cd server
python -m venv .venv
source .venv/bin/activate  # On Windows: .venv\Scripts\activate
```

2. Install dependencies:

```bash
pip install -r requirements.txt
```

3. Create a `.env` file (copy from `env.example`):

```bash
cp env.example .env
```

4. Initialize the database:

```bash
python -m app.db.init_db
```

5. Initialize users:

```bash
python -m app.init_users
```

### Running the Server

```bash
python start.py
```

The API will be available at `http://localhost:8000`

### API Documentation

Once running, you can access:

- Interactive API docs: `http://localhost:8000/docs`
- Alternative API docs: `http://localhost:8000/redoc`

## API Endpoints

- `GET /` - API info
- `GET /health` - Health check
- `GET /authenticate` - Test authentication
- `GET /names` - Get list of names to vote on
- `POST /name/{name_id}` - Vote on a name

## Authentication

The API uses HTTP Basic Authentication. Default users:

- Username: `emil`, Password: `950615`
- Username: `agnes`, Password: `verysecret`

## Deployment to Render.com

### Using render.yaml (Recommended)

1. Push your code to GitHub
2. Connect your GitHub repo to Render
3. Render will automatically detect the `render.yaml` file and:

   - Create a PostgreSQL database
   - Set up the web service
   - Configure environment variables

4. After deployment, set the `CORS_ORIGINS` environment variable in the Render dashboard to your frontend URL

### What Render Creates

- **Web Service**: Runs your FastAPI application
- **PostgreSQL Database**: Free tier database for data persistence
- **Environment Variables**: Automatically configured

### Post-Deployment

The database and default users will be automatically initialized on first startup.

## Environment Variables

- `ENV` - Environment mode (development/production)
- `DATABASE_URL` - PostgreSQL connection string (automatically set by Render)
- `CORS_ORIGINS` - Comma-separated list of allowed CORS origins
- `SECRET_KEY` - Secret key for authentication (auto-generated by Render)
- `HOST` - Server host (default: 0.0.0.0)
- `PORT` - Server port (default: 8000, Render uses 10000)

## Database Schema

### Users

- `username` (primary key)
- `name`
- `password` (hashed)

### Names

- `id` (primary key)
- `name`
- `gender`

### Votes

- `id` (primary key)
- `name_id` (foreign key)
- `username` (foreign key)
- `vote` (0: dislike, 1: like, 2: superlike)
- `created_at`

## Troubleshooting

### Database Issues

For local SQLite issues:

```bash
rm server/app/db/app.db
python -m app.db.init_db
python -m app.init_users
```

For production PostgreSQL issues, check the Render logs.

### CORS Issues

Make sure to add your frontend URL to the `CORS_ORIGINS` environment variable.

### Authentication Issues

Ensure you're using the correct username/password combination and sending them as HTTP Basic Auth headers.
